<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SkAi - Your AI Assistant</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    body{
      font-family:'Inter','Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#1e3a8a 0%,#3b82f6 55%,#60a5fa 100%);
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
    }

    .chat-container{
      width:480px;height:650px;background:#fff;border-radius:24px;
      box-shadow:0 25px 50px rgba(59,130,246,.28);
      display:flex;flex-direction:column;overflow:hidden;border:1px solid rgba(59,130,246,.18);
    }

    .chat-header{
      background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);
      color:#fff;padding:25px 20px;text-align:center;position:relative;
      box-shadow:0 4px 20px rgba(59,130,246,.35);
    }
    .chat-header::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.12)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
    }
    .chat-header-content{position:relative;z-index:2}
    .chat-header h1{font-size:28px;font-weight:700;margin-bottom:5px;text-shadow:0 2px 4px rgba(0,0,0,.1)}
    .chat-header p{font-size:15px;opacity:.95;font-weight:400}

    .status-indicator{
      position:absolute;top:25px;right:25px;width:14px;height:14px;background:#60a5fa;border-radius:50%;
      box-shadow:0 0 15px rgba(96,165,250,.8);z-index:3;
    }
    .status-indicator::after{
      content:'';position:absolute;top:-3px;left:-3px;right:-3px;bottom:-3px;
      border:2px solid rgba(96,165,250,.3);border-radius:50%;animation:pulse 2s infinite;
    }
    @keyframes pulse{0%{transform:scale(1);opacity:1}100%{transform:scale(1.4);opacity:0}}

    .chat-body{
      flex:1;padding:25px;overflow-y:auto;background:linear-gradient(to bottom,#f8fafc,#f1f5f9);
      display:flex;flex-direction:column;gap:15px;min-height:0;
    }

    .bot-message,.user-message,.promotion-message{
      max-width:85%;padding:16px 20px;border-radius:20px;font-size:14px;line-height:1.5;
      white-space:pre-line;animation:slideIn .4s ease-out;
    }
    @keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

    .bot-message{
      background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);
      color:white;align-self:flex-start;box-shadow:0 4px 15px rgba(59,130,246,.3);
    }
    .user-message{
      background:#e2e8f0;color:#1e293b;align-self:flex-end;box-shadow:0 4px 15px rgba(0,0,0,.05);
    }
    .promotion-message{
      background:linear-gradient(135deg,#60a5fa 0%,#3b82f6 100%);color:white;align-self:flex-start;
      border-left:4px solid #2563eb;font-weight:500;box-shadow:0 4px 15px rgba(96,165,250,.3);
    }

    .chat-input{
      padding:25px;background:white;border-top:1px solid #e2e8f0;
      display:flex;gap:12px;align-items:center;
    }
    .chat-input input{
      flex:1;padding:16px 20px;border:2px solid #e2e8f0;border-radius:50px;font-size:15px;
      outline:none;transition:all .3s ease;background:#f8fafc;
    }
    .chat-input input:focus{
      border-color:#3b82f6;background:white;box-shadow:0 0 0 4px rgba(59,130,246,.1);
    }
    .chat-input button{
      background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:white;border:none;
      padding:16px 24px;border-radius:50px;cursor:pointer;font-size:15px;font-weight:600;
      transition:all .3s ease;box-shadow:0 4px 15px rgba(59,130,246,.3);min-width:80px;
    }
    .chat-input button:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(59,130,246,.4)}
    .chat-input button:disabled{
      opacity:.6;cursor:not-allowed;transform:none;box-shadow:0 4px 15px rgba(59,130,246,.2);
    }

    .connection-status{
      position:fixed;top:20px;left:50%;transform:translateX(-50%);
      background:rgba(59,130,246,.95);color:white;padding:12px 24px;border-radius:50px;
      font-size:14px;font-weight:600;z-index:1000;display:none;
      box-shadow:0 8px 25px rgba(59,130,246,.4);
    }
    .connection-status.success{
      background:rgba(96,165,250,.95);box-shadow:0 8px 25px rgba(96,165,250,.4);
    }
    .connection-status.error{
      background:rgba(239,68,68,.95);box-shadow:0 8px 25px rgba(239,68,68,.4);
    }

    .typing-indicator{
      display:flex;align-items:center;gap:8px;padding:16px 20px;
      background:linear-gradient(135deg,#f1f5f9 0%,#e2e8f0 100%);
      border-radius:20px;align-self:flex-start;max-width:85%;
    }
    .typing-dots{display:flex;gap:4px}
    .typing-dot{
      width:8px;height:8px;background:#64748b;border-radius:50%;
      animation:typing 1.6s infinite ease-in-out;
    }
    .typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}
    @keyframes typing{
      0%,80%,100%{transform:scale(.8);opacity:.5}
      40%{transform:scale(1.2);opacity:1}
    }

    .purchase-button{
      display:inline-block;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);
      color:white !important;padding:12px 24px;border-radius:50px;text-decoration:none !important;
      font-weight:700;font-size:14px;margin:8px 0;transition:all .3s ease;
      box-shadow:0 4px 15px rgba(59,130,246,.4);border:none;cursor:pointer;
      text-align:center;min-width:180px;min-height:44px;
    }
    .purchase-button:hover{
      transform:translateY(-3px);box-shadow:0 8px 25px rgba(59,130,246,.6);color:white !important;
    }
    .purchase-button:active{transform:translateY(-1px)}

    .chat-body::-webkit-scrollbar{width:8px}
    .chat-body::-webkit-scrollbar-track{background:#f1f5f9;border-radius:4px}
    .chat-body::-webkit-scrollbar-thumb{
      background:linear-gradient(135deg,#cbd5e1,#94a3b8);border-radius:4px;
    }
    .chat-body::-webkit-scrollbar-thumb:hover{
      background:linear-gradient(135deg,#94a3b8,#64748b);
    }

    .bot-message a:not(.purchase-button){
      color:#93c5fd;text-decoration:underline;font-weight:600;
    }
    .bot-message a:not(.purchase-button):hover{color:#bfdbfe}

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body{padding:0;background:linear-gradient(135deg,#1e3a8a 0%,#3b82f6 55%,#60a5fa 100%)}
      .chat-container{
        width:100vw;height:100vh;border-radius:0;max-height:100vh;border:none;box-shadow:none;
      }
      .chat-header{padding:20px 15px 15px 15px;padding-top:env(safe-area-inset-top,20px)}
      .chat-header h1{font-size:24px}
      .chat-header p{font-size:14px}
      .chat-body{padding:15px;gap:12px}
      .bot-message,.user-message,.promotion-message{
        max-width:95%;padding:12px 16px;font-size:14px;border-radius:16px;
      }
      .chat-input{
        padding:15px;padding-bottom:calc(15px + env(safe-area-inset-bottom,0px));gap:10px;
      }
      .chat-input input{padding:14px 18px;font-size:16px;border-radius:25px}
      .chat-input button{
        padding:14px 20px;font-size:14px;border-radius:25px;min-width:70px;min-height:44px;
      }
      .purchase-button{
        padding:12px 20px;font-size:14px;min-width:160px;margin:8px 0;
        border-radius:25px;min-height:44px;
      }
      .typing-indicator{padding:12px 16px;border-radius:16px}
      .status-indicator{top:20px;right:20px;width:12px;height:12px}
      .connection-status{top:10px;padding:8px 16px;font-size:12px;border-radius:20px}
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .chat-container{width:600px;height:750px}
      .chat-header{padding:25px 20px}
      .chat-body{padding:25px}
      .chat-input{padding:25px}
    }

    @media (min-width: 1025px) {
      .chat-container{width:480px;height:650px}
      .chat-input button:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(59,130,246,.4)}
      .purchase-button:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(59,130,246,.6)}
      .bot-message,.user-message,.promotion-message{transition:all .3s ease}
    }

    @supports (-webkit-touch-callout: none) {
      .chat-container{height:100vh;height:-webkit-fill-available}
      .chat-input input{font-size:16px;border-radius:25px}
    }

    @media screen and (max-width: 768px) {
      .chat-input input:focus{transform:none}
    }
  </style>
</head>
<body>
<div class="connection-status" id="connectionStatus">Connecting...</div>
<div class="chat-container">
<div class="chat-header">
<div class="status-indicator"></div>
<div class="chat-header-content">
<h1>SkAi</h1>
<p>Tambi√©n hablo espa√±ol</p>
</div>
</div>
<div class="chat-body" id="chat-body">
</div>
<div class="chat-input">
<input type="text" id="user-input" placeholder="Type your message here..." />
<button onclick="sendMessage()" id="send-button">Send</button>
</div>
</div>

<script type="module">
// ===== CONFIGURATION =====
const CHATBOT_ID = "e16c36cb-d8ee-4143-a9c7-3c1a521ebfba";
const BACKEND_URL = "https://hsrpibsdfzzzvfmfakqu.supabase.co/functions/v1/chatbot-proxy";

// State variables
let sessionId = crypto.randomUUID();
let currentThreadId = null;
let retryCount = 0;
const MAX_RETRIES = 2;
let userEmail = null;
let emailCaptured = false;

console.log('üöÄ SkAi High-Performance Chatbot initializing...');

// ===== EMAIL VALIDATION =====
function isValidEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

function extractEmail(message) {
  const emailRegex = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
  const matches = message.match(emailRegex);
  return matches ? matches[0] : null;
}

// ===== SAVE EMAIL TO SUPABASE =====
async function saveEmailToSupabase(email, businessInfo) {
  try {
    const response = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        chatbot_id: CHATBOT_ID,
        action: 'save_lead',
        email: email,
        business_info: businessInfo,
        session_id: sessionId,
        captured_at: new Date().toISOString()
      })
    });

    if (!response.ok) {
      throw new Error('Failed to save email');
    }

    const result = await response.json();
    console.log('‚úÖ Email saved to Supabase:', email);
    return result;
  } catch (error) {
    console.error('‚ùå Error saving email:', error);
    // Don't throw - we don't want to break the chat if email save fails
  }
}

// ===== PERFORMANCE OPTIMIZATION: Pre-create thread on load =====
async function initializeThread() {
  try {
    console.log('‚ö° Pre-warming thread for faster first response...');
    await createThread();
    console.log('‚úÖ Thread ready! First message will be instant.');
  } catch (error) {
    console.log('‚ö†Ô∏è Thread pre-warming failed, will create on first message');
  }
}

// UI Functions
function showConnectionStatus(message, type = 'info') {
  const status = document.getElementById('connectionStatus');
  status.textContent = message;
  status.className = `connection-status ${type}`;
  status.style.display = 'block';
  setTimeout(() => {
    status.style.display = 'none';
  }, 3000);
}

function addMessage(content, className = "bot-message") {
  const chatBody = document.getElementById("chat-body");
  const msg = document.createElement("div");
  msg.className = className;

  if (className === "bot-message" || className === "promotion-message") {
    const linkRegex = /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;
    let processedContent = content.replace(linkRegex, (match, text, url) => {
      if (url.includes('stripe.com') || url.includes('booking') || url.includes('reserve') || url.includes('buy')) {
        return `<a href="${url}" target="_blank" class="purchase-button">${text}</a>`;
      } else {
        return `<a href="${url}" target="_blank" style="color: #93c5fd; text-decoration: underline;">${text}</a>`;
      }
    });

    processedContent = processedContent.replace(
      /(https?:\/\/[^\s\)]+)(?![^<]*<\/a>)/g,
      '<a href="$1" target="_blank" style="color: #93c5fd; text-decoration: underline;">$1</a>'
    );

    msg.innerHTML = processedContent;
  } else {
    msg.textContent = content;
  }

  chatBody.appendChild(msg);
  chatBody.scrollTop = chatBody.scrollHeight;
  return msg;
}

function showTypingIndicator() {
  const chatBody = document.getElementById("chat-body");
  const typingDiv = document.createElement("div");
  typingDiv.className = "typing-indicator";
  typingDiv.id = "typing-indicator";

  const dotsContainer = document.createElement("div");
  dotsContainer.className = "typing-dots";

  for (let i = 0; i < 3; i++) {
    const dot = document.createElement("div");
    dot.className = "typing-dot";
    dotsContainer.appendChild(dot);
  }

  typingDiv.appendChild(dotsContainer);
  chatBody.appendChild(typingDiv);
  chatBody.scrollTop = chatBody.scrollHeight;
  return typingDiv;
}

function removeTypingIndicator() {
  const typing = document.getElementById("typing-indicator");
  if (typing) {
    typing.remove();
  }
}

// Backend API Functions with improved error handling
async function callBackend(action, payload = {}, attempt = 1) {
  try {
    console.log(`üîÑ Calling backend: ${action} (attempt ${attempt}/${MAX_RETRIES + 1})`);
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 45000); // 45 second timeout
    
    const response = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        chatbot_id: CHATBOT_ID,
        action: action,
        ...payload
      }),
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      const errorText = await response.text();
      console.error(`‚ùå Backend error ${response.status}:`, errorText);
      throw new Error(`Backend error: ${response.status} - ${errorText}`);
    }

    const result = await response.json();
    
    if (!result.success) {
      console.error('‚ùå Backend returned error:', result.error);
      throw new Error(result.error || 'Backend request failed');
    }

    console.log(`‚úÖ Backend call successful: ${action}`);
    return result.data;
    
  } catch (error) {
    if (error.name === 'AbortError') {
      console.error('‚ùå Request timeout after 45 seconds');
      throw new Error('Response timeout - the AI is taking too long to respond');
    }
    
    // Retry logic for network errors
    if (attempt <= MAX_RETRIES && (error.message.includes('fetch') || error.message.includes('network'))) {
      console.log(`üîÑ Retrying... (${attempt}/${MAX_RETRIES})`);
      await new Promise(resolve => setTimeout(resolve, 1000 * attempt)); // Exponential backoff
      return callBackend(action, payload, attempt + 1);
    }
    
    console.error('‚ùå Backend call failed:', error);
    throw error;
  }
}

async function createThread() {
  try {
    const thread = await callBackend('create_thread');
    currentThreadId = thread.id;
    console.log('‚úÖ Thread created:', currentThreadId);
    return currentThreadId;
  } catch (error) {
    console.error('‚ùå Error creating thread:', error);
    throw error;
  }
}

async function sendToBackend(message) {
  try {
    if (!currentThreadId) {
      console.log('üìù Creating new thread...');
      await createThread();
    }

    console.log('üì§ Sending message to backend...');
    const response = await callBackend('send_message', {
      message: message,
      thread_id: currentThreadId
    });

    console.log('‚úÖ Response received from backend');
    return response;
    
  } catch (error) {
    console.error('‚ùå Error with backend:', error);
    
    // If thread error, try creating new thread once
    if (error.message.includes('thread') && retryCount < 1) {
      retryCount++;
      console.log('üîÑ Thread issue detected, creating new thread...');
      currentThreadId = null;
      return sendToBackend(message);
    }
    
    throw error;
  }
}

async function saveChatHistory(userMessage, botResponse) {
  try {
    await callBackend('save_chat', {
      message: userMessage,
      response: botResponse,
      session_id: sessionId,
      email: userEmail // Include email if captured
    });
    console.log('üíæ Chat history saved');
  } catch (error) {
    console.error("‚ö†Ô∏è Error saving chat history:", error);
    // Don't throw - this is not critical
  }
}

async function sendMessage() {
  const input = document.getElementById("user-input");
  const message = input.value.trim();
  if (message === "") return;

  const sendButton = document.getElementById("send-button");
  sendButton.disabled = true;
  retryCount = 0; // Reset retry count for new message

  addMessage(message, "user-message");
  input.value = "";

  // Check for email in the message
  if (!emailCaptured) {
    const detectedEmail = extractEmail(message);
    if (detectedEmail && isValidEmail(detectedEmail)) {
      userEmail = detectedEmail;
      emailCaptured = true;
      console.log('üìß Email captured:', userEmail);
      
      // Save email to Supabase
      await saveEmailToSupabase(userEmail, message);
      
      showConnectionStatus('‚úì Email saved!', 'success');
    }
  }

  showTypingIndicator();

  try {
    console.log('üí¨ Processing message:', message);
    const response = await sendToBackend(message);
    removeTypingIndicator();
    addMessage(response, "bot-message");
    await saveChatHistory(message, response);
    console.log('‚úÖ Message processed successfully');
  } catch (error) {
    console.error("‚ùå Message processing error:", error);
    removeTypingIndicator();
    
    let errorMessage = "I apologize, but I'm having trouble connecting right now. ";
    
    if (error.message.includes('timeout')) {
      errorMessage += "The response is taking longer than expected. Please try again with a shorter question, or contact us directly at (956) 905-2568.";
    } else if (error.message.includes('network') || error.message.includes('fetch')) {
      errorMessage += "Please check your internet connection and try again.";
    } else {
      errorMessage += "Please try again in a moment. If the issue persists, call us at (956) 905-2568.";
    }
    
    addMessage(errorMessage, "bot-message");
  }

  sendButton.disabled = false;
  input.focus();
}

// Initialize on page load
document.addEventListener("DOMContentLoaded", async function () {
  console.log('üéØ DOM loaded, initializing SkAi...');

  // Pre-warm thread for faster first response
  initializeThread();

  // Add new welcome message
  setTimeout(() => {
    addMessage("Hi! Great to have you here!\n\nBefore we get started, tell me a bit about your business or the product you offer.\n\nAnd please share your email so we can continue üëå", "bot-message");
  }, 800);

  const input = document.getElementById("user-input");
  input.addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
      event.preventDefault();
      sendMessage();
    }
  });

  input.focus();
  console.log('‚úÖ SkAi chatbot ready!');
});

// Make functions available globally
window.sendMessage = sendMessage;
</script>
</body>
</html>
